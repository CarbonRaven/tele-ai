; =============================================================================
; Payphone-AI Per-Service Routing Dialplan
; =============================================================================
;
; Routes dialed numbers to the payphone-app via AudioSocket, encoding the
; dialed extension into the UUID field as EXTEN:UNIQUEID. The Python side
; parses this to route directly to the correct feature/service.
;
; Installation:
;   1. Copy to /etc/asterisk/ or append to extensions_custom.conf
;   2. Reload dialplan: asterisk -rx "dialplan reload"
;   3. Point the HT801 ATA to this context
;
; HT801 ATA dial plan should be: { x+ | *x+ | #x+ }
;   This allows any digit sequence to be sent.
;
; All routing logic stays in Python. This dialplan just forwards whatever
; was dialed, encoded in the AudioSocket UUID field.
;

; === HT801 ATA Digit Collection & Timing ===
;
; The Grandstream HT801 ATA collects ALL digits before sending the complete
; string to Asterisk. Asterisk pattern matching only sees the final result.
;
; How digit collection works:
;   1. User picks up handset and dials digits on the payphone keypad.
;   2. ATA buffers digits locally, waiting for more input.
;   3. After the inter-digit timeout expires (default 4 seconds of no input),
;      the ATA sends the complete digit string to Asterisk as the extension.
;   4. User can press # at any time to send immediately without waiting.
;
; Recommended HT801 settings (Web UI -> FXS Port -> Dial Plan):
;   - Dial Plan: { x+ | *x+ | #x+ }   (accept any digit sequence)
;   - No Key Entry Timeout: 4           (seconds, default; lower = snappier)
;   - Inter-digit Timeout:  4           (seconds, how long to wait between digits)
;
; Timing trade-offs:
;   - Shorter timeout (2-3s): Faster connection, but less time to dial 7+ digits.
;   - Longer timeout (4-5s):  Comfortable dialing, but noticeable pause after last digit.
;   - The # key bypass makes longer timeouts more tolerable: experienced users
;     press # immediately, casual users just wait.
;
; Note: Single-digit shortcuts (0-9) benefit most from the # bypass since
; the ATA would otherwise wait the full inter-digit timeout for more digits.

[payphone-incoming]
; Handset pickup, no digits dialed -> operator
exten => s,1,Answer()
 same => n,Set(CHANNEL(audioreadformat)=slin16)
 same => n,Set(CHANNEL(audiowriteformat)=slin16)
 same => n,AudioSocket(operator:${UNIQUEID},10.10.10.10:9092)
 same => n,Hangup()

; Single digit (0-9) shortcuts
exten => _X,1,Answer()
 same => n,Set(CHANNEL(audioreadformat)=slin16)
 same => n,Set(CHANNEL(audiowriteformat)=slin16)
 same => n,AudioSocket(${EXTEN}:${UNIQUEID},10.10.10.10:9092)
 same => n,Hangup()

; Any multi-digit number (2+ digits)
exten => _XX.,1,Answer()
 same => n,Set(CHANNEL(audioreadformat)=slin16)
 same => n,Set(CHANNEL(audiowriteformat)=slin16)
 same => n,AudioSocket(${EXTEN}:${UNIQUEID},10.10.10.10:9092)
 same => n,Hangup()

; Invalid extension handler
exten => i,1,Answer()
 same => n,Set(CHANNEL(audioreadformat)=slin16)
 same => n,Set(CHANNEL(audiowriteformat)=slin16)
 same => n,AudioSocket(invalid:${UNIQUEID},10.10.10.10:9092)
 same => n,Hangup()

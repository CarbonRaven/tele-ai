; =============================================================================
; Payphone-AI Ready Call Dialplan
; =============================================================================
;
; This dialplan context handles the "system ready" announcement call.
; Add this to your FreePBX custom extensions or include it in extensions.conf
;
; Installation:
;   1. Copy to /etc/asterisk/extensions_custom.conf (append)
;   2. Or include from extensions.conf: #include extensions_ready.conf
;   3. Reload dialplan: asterisk -rx "dialplan reload"
;
; Usage:
;   The payphone-ops.sh ready-call command creates a call file that uses
;   this context to play an announcement when the payphone answers.
;

; -----------------------------------------------------------------------------
; Ready Announcement (Pre-recorded audio)
; -----------------------------------------------------------------------------
; Uses a pre-recorded audio file for the announcement
; Place your audio file at: /var/lib/asterisk/sounds/custom/system-ready.wav
;
[ready-announcement]
exten => s,1,NoOp(System Ready Announcement)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Playback(custom/system-ready)
 same => n,Wait(1)
 same => n,Hangup()

; -----------------------------------------------------------------------------
; Ready Announcement with TTS (AudioSocket)
; -----------------------------------------------------------------------------
; Uses the payphone-app's AudioSocket server for live TTS
; The message is passed via the READY_MESSAGE channel variable
;
[ready-announcement-tts]
exten => s,1,NoOp(System Ready Announcement via TTS)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Set(UUID=${UNIQUEID})
 same => n,AudioSocket(${UUID},127.0.0.1:9092)
 same => n,Hangup()

; -----------------------------------------------------------------------------
; Ready Announcement with Festival TTS (Alternative)
; -----------------------------------------------------------------------------
; Uses Festival TTS if installed (simpler, no external service needed)
;
[ready-announcement-festival]
exten => s,1,NoOp(System Ready Announcement via Festival)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Festival(Payphone A I system is fully operational)
 same => n,Wait(0.5)
 same => n,Festival(All services verified and ready for use)
 same => n,Wait(0.5)
 same => n,Festival(Have a nice day)
 same => n,Wait(1)
 same => n,Hangup()

; -----------------------------------------------------------------------------
; System Status Check (Interactive)
; -----------------------------------------------------------------------------
; Allows calling an extension to hear system status
; Useful for remote verification
;
[system-status]
exten => s,1,NoOp(System Status Check)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Playback(beep)
 same => n,System(echo "System status check at $(date)" >> /var/log/asterisk/status-checks.log)
 same => n,Festival(System status check)
 same => n,Wait(0.5)
 ; Check if payphone app is responding
 same => n,Set(SOCKET_TEST=${SHELL(nc -zv 127.0.0.1 9092 2>&1 | grep -c succeeded)})
 same => n,GotoIf($[${SOCKET_TEST} > 0]?app_ok:app_fail)
 same => n(app_ok),Festival(Voice application is running)
 same => n,Goto(check_ollama)
 same => n(app_fail),Festival(Warning. Voice application is not responding)
 same => n(check_ollama),NoOp(Checking Ollama)
 ; Check Ollama (basic connectivity)
 same => n,Set(OLLAMA_TEST=${SHELL(curl -s -o /dev/null -w "%{http_code}" http://10.10.10.11:11434/api/tags 2>/dev/null)})
 same => n,GotoIf($[${OLLAMA_TEST} = 200]?llm_ok:llm_fail)
 same => n(llm_ok),Festival(Language model is online)
 same => n,Goto(done)
 same => n(llm_fail),Festival(Warning. Language model is not responding)
 same => n(done),Wait(0.5)
 same => n,Festival(Status check complete)
 same => n,Wait(1)
 same => n,Hangup()

; -----------------------------------------------------------------------------
; Emergency Shutdown Trigger
; -----------------------------------------------------------------------------
; Call this extension to initiate system shutdown
; Protected by password
;
[emergency-shutdown]
exten => s,1,NoOp(Emergency Shutdown)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Playback(beep)
 same => n,Festival(Enter shutdown password followed by pound)
 same => n,Read(PASSWORD,,4,,,5)
 same => n,GotoIf($[${PASSWORD} = 1234]?shutdown:denied)
 same => n(denied),Festival(Access denied)
 same => n,Hangup()
 same => n(shutdown),Festival(Initiating system shutdown in 30 seconds)
 same => n,System(/home/payphone/tele-ai/scripts/payphone-ops.sh shutdown &)
 same => n,Hangup()
